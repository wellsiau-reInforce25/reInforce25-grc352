name: 'Push / Commit - Checks'

on:
  push:
    branches: [ main, develop ]

jobs:
  tf-format-and-lint:
    name: 'Terraform Format and linting'
    runs-on: ubuntu-latest
    outputs:
      tflint_status: ${{ steps.tf-lint-run.outcome }}
    steps:
      - uses: actions/checkout@v4

      ###### PLACEHOLDER FOR TF LINTING ######
      - name: Cache plugin dir
        uses: actions/cache@v4
        with:
          path: ~/.tflint.d/plugins
          key: ${{ matrix.os }}-tflint-${{ hashFiles('.tflint.hcl') }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.11.2"

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: v0.52.0

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: Init TFLint
        id: tf-lint-init
        run: tflint --init --config=.config/tf-lint/.tflint.hcl
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Run TFLint
        id: tf-lint-run
        run: tflint --config=.config/tf-lint/.tflint.hcl
      ########################################

  tf-static-checks:
    name: 'Terraform Static Checks'
    runs-on: ubuntu-latest
    needs: [tf-format-and-lint]
    outputs:
      checkov_status: ${{ steps.checkov-run.outcome }}
    steps:
      - uses: actions/checkout@v4

      ###### PLACEHOLDER FOR CHECKOV TF ######
      - name: Checkov HCL Scan
        id: checkov-run
        uses: bridgecrewio/checkov-action@v12
        with:
          config_file: .config/checkov/.checkov.yaml
          output_format: cli
          output_file_path: console
          framework: terraform
          directory: ./terraform

      - name: Checkov Report
        id: checkov-report
        working-directory: ./terraform
        if: always()
        env:
          CHECKOV_STATUS: "${{ steps.checkov-run.outcome }}"
        run: |
          echo "Checkov scan status: $CHECKOV_STATUS" >> $GITHUB_STEP_SUMMARY
          echo "$CHECKOV_RESULTS" >> $GITHUB_STEP_SUMMARY
      ########################################

  cfn-format-and-lint:
    name: 'CloudFormation Format and linting'
    runs-on: ubuntu-latest
    outputs:
      cfnlint_status: ${{ steps.cfn-lint-run.outcome }}
    steps:
      - uses: actions/checkout@v4

      ###### PLACEHOLDER FOR CFN LINTING ######
      - name: Setup Cfn Lint
        id: cfn-lint
        uses: scottbrenner/cfn-lint-action@v2

      - name: Run Cfn Lint
        id: cfn-lint-run
        run: |
          shopt -s globstar # enable globbing
          cfn-lint --version
          cfn-lint -t ./cloudformation/*.yaml
      #########################################

  cfn-static-checks:
    name: 'CloudFormation Static Checks'
    runs-on: ubuntu-latest
    needs: [cfn-format-and-lint]
    outputs:
      checkov_status: ${{ steps.checkov-run.outcome }}
    steps:
      - uses: actions/checkout@v4

      ###### PLACEHOLDER FOR CHECKOV CFN ######
      - name: Checkov CFN Scan
        id: checkov-run
        uses: bridgecrewio/checkov-action@v12
        with:
          config_file: .config/checkov/.checkov.yaml
          output_format: cli
          output_file_path: console
          framework: cloudformation
          directory: ./cloudformation

      - name: Checkov Report
        id: checkov-report
        if: always()
        env:
          CHECKOV_STATUS: "${{ steps.checkov-run.outcome }}"
        run: |
          echo "Checkov scan status: $CHECKOV_STATUS" >> $GITHUB_STEP_SUMMARY
          echo "$CHECKOV_RESULTS" >> $GITHUB_STEP_SUMMARY
      #########################################

###### PLACEHOLDER FOR SUMMARY STEP ######

##########################################